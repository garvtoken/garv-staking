<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GARV Token Staking</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="./config.js"></script>

<style>
body {
  background:#0b1220;
  color:#fff;
  font-family: Arial, sans-serif;
  display:flex;
  justify-content:center;
  padding:20px;
}
.box {
  width:100%;
  max-width:420px;
  background:#111827;
  padding:20px;
  border-radius:14px;
}
h2 { text-align:center; }
button,input {
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  font-size:15px;
}
.primary { background:#2563eb; color:white; }
.gray { background:#374151; color:white; }
.disabled { background:#1f2937; color:#9ca3af; }
.small {
  font-size:13px;
  color:#9ca3af;
  text-align:center;
  margin-top:8px;
}
.notice {
  background:#1f2937;
  padding:10px;
  border-radius:8px;
  font-size:13px;
  margin-top:10px;
}
.row {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-top:6px;
}
</style>
</head>

<body>
<div class="box">

<h2>GARV Token Staking</h2>

<p id="walletStatus" class="small">Wallet: Not Connected</p>

<button id="connectBtn" class="primary" onclick="connectWallet()">
  Connect Wallet
</button>

<input id="amount" placeholder="Enter GARV amount" />

<button id="approveBtn" class="gray" onclick="approve()" disabled>
  Approve GARV
</button>

<button id="stakeBtn" class="gray" onclick="stake()" disabled>
  Stake GARV
</button>

<div class="notice">
  <div class="row">
    <span>Staked Amount</span>
    <span id="staked">0</span>
  </div>
  <div class="row">
    <span>Unlock In</span>
    <span id="countdown">--</span>
  </div>
</div>

<button id="withdrawBtn" class="disabled" onclick="withdraw()" disabled>
  Withdraw
</button>

<div class="notice">
  ðŸ”’ Lock Period: 365 Days<br>
  ðŸ’° Minimum: 15 USDT worth GARV<br>
  âš™ Non-custodial â€¢ On-chain â€¢ Transparent
</div>

</div>

<script>
let provider, signer, user, token, staking, decimals = 18;
let timerInterval;

async function connectWallet() {
  try {
    if (!window.ethereum) {
      alert("Please open this DApp in TokenPocket / MetaMask browser");
      return;
    }

    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    user = await signer.getAddress();

    const net = await provider.getNetwork();
    if (net.chainId !== CHAIN_ID) {
      alert("Please switch to BSC Mainnet");
      return;
    }

    token = new ethers.Contract(GARV_TOKEN, TOKEN_ABI, signer);
    staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);

    try { decimals = await token.decimals(); } catch {}

    document.getElementById("walletStatus").innerText =
      "Connected: " + user.slice(0,6) + "..." + user.slice(-4);

    document.getElementById("connectBtn").disabled = true;
    document.getElementById("approveBtn").disabled = false;
    document.getElementById("stakeBtn").disabled = false;

    loadStake();

  } catch (e) {
    console.error(e);
    alert("Wallet connection failed");
  }
}

async function approve() {
  const amt = document.getElementById("amount").value;
  if (!amt) return alert("Enter GARV amount");

  const val = ethers.utils.parseUnits(amt, decimals);
  const tx = await token.approve(STAKING_CONTRACT, val);
  await tx.wait();

  alert("Approval successful");
}

async function stake() {
  const amt = document.getElementById("amount").value;
  if (!amt) return alert("Enter GARV amount");

  const val = ethers.utils.parseUnits(amt, decimals);
  const tx = await staking.stake(val);
  await tx.wait();

  alert("Stake successful");
  loadStake();
}

async function withdraw() {
  const tx = await staking.withdraw();
  await tx.wait();

  alert("Withdraw successful");
  loadStake();
}

async function loadStake() {
  if (!staking || !user) return;

  const info = await staking.getStakeInfo(user);
  const amount = ethers.utils.formatUnits(info[0], decimals);
  document.getElementById("staked").innerText = amount;

  if (timerInterval) clearInterval(timerInterval);

  const unlock = Number(info[2]) * 1000;
  startTimer(unlock);
}

function startTimer(unlock) {
  const btn = document.getElementById("withdrawBtn");

  timerInterval = setInterval(() => {
    const diff = unlock - Date.now();

    if (diff <= 0) {
      document.getElementById("countdown").innerText = "Unlocked";
      btn.disabled = false;
      btn.className = "primary";
      clearInterval(timerInterval);
    } else {
      const d = Math.floor(diff / 86400000);
      const h = Math.floor(diff / 3600000) % 24;
      const m = Math.floor(diff / 60000) % 60;
      document.getElementById("countdown").innerText =
        ${d}d ${h}h ${m}m;
      btn.disabled = true;
      btn.className = "disabled";
    }
  }, 1000);
}
</script>

</body>
</html>
