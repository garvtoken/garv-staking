<script>
let provider, signer, user, token, staking, decimals;

async function connect() {
  try {
    if (!window.ethereum) {
      alert("Please open this DApp inside TokenPocket / MetaMask browser");
      return;
    }

    const accounts = await window.ethereum.request({
      method: "eth_requestAccounts"
    });

    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    user = accounts[0];

    const network = await provider.getNetwork();
    if (network.chainId !== CHAIN_ID) {
      alert("Please switch to BSC Mainnet");
      return;
    }

    token = new ethers.Contract(GARV_TOKEN, TOKEN_ABI, signer);
    staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
    decimals = await token.decimals();

    document.getElementById("wallet").innerText =
      "Connected: " + user.slice(0,6) + "..." + user.slice(-4);

    loadStake();

  } catch (err) {
    console.error(err);
    alert("Wallet connection failed");
  }
}

async function approve(){
  const amt = document.getElementById("amount").value;
  if(!amt) return alert("Enter amount");

  const val = ethers.utils.parseUnits(amt, decimals);
  const tx = await token.approve(STAKING_CONTRACT, val);
  await tx.wait();
  alert("Approved successfully");
}

async function stake(){
  const amt = document.getElementById("amount").value;
  if(!amt) return alert("Enter amount");

  const val = ethers.utils.parseUnits(amt, decimals);
  const tx = await staking.stake(val);
  await tx.wait();
  alert("Staked successfully");
  loadStake();
}

async function loadStake(){
  const info = await staking.getStakeInfo(user);
  const amount = ethers.utils.formatUnits(info[0], decimals);
  document.getElementById("staked").innerText = amount;

  const unlock = Number(info[2]) * 1000;
  startTimer(unlock);
}

function startTimer(unlock){
  const btn = document.getElementById("withdrawBtn");

  setInterval(()=>{
    const diff = unlock - Date.now();
    if(diff <= 0){
      document.getElementById("countdown").innerText = "Unlocked";
      btn.disabled = false;
    } else {
      btn.disabled = true;
      const d = Math.floor(diff / 86400000);
      const h = Math.floor(diff / 3600000) % 24;
      const m = Math.floor(diff / 60000) % 60;
      document.getElementById("countdown").innerText =
        ${d}d ${h}h ${m}m;
    }
  },1000);
}

async function withdraw(){
  const tx = await staking.withdraw();
  await tx.wait();
  alert("Withdraw successful");
}
</script>
