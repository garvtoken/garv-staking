<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GARV Token Staking</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(180deg,#071c2f,#0b2a45);
  color:#fff;
}
.container{
  max-width:420px;
  margin:40px auto;
  padding:20px;
}
.card{
  background:#0f3558;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
}
h1{
  text-align:center;
  margin-bottom:10px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#1ea7ff;
  color:#fff;
  font-size:16px;
}
input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-bottom:10px;
}
.small{
  font-size:13px;
  opacity:.8;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">

<h1>GARV Token Stake Now</h1>

<div class="card">
  <div id="walletStatus" class="small">Wallet: Not Connected</div><br>
  <button onclick="connectWallet()">Connect Wallet</button>
</div>

<div class="card">
  <b>Live GARV Price</b><br>
  <div id="price">via PancakeSwap (on-chain)</div>
</div>

<div class="card">
  <input type="number" id="amount" placeholder="Enter GARV Amount">
  <button onclick="stake()">Stake GARV</button>
</div>

<div class="card">
  <button onclick="checkStake()">Check My Stake</button>
</div>

<div class="small">
This DApp works only inside decentralized wallets  
(MetaMask / TokenPocket)
</div>

</div>

<script>
/* ================= ADDRESSES ================= */
const GARV_TOKEN_ADDRESS = "0x15e4f5092af30ea702dcbac71194ccf08885688d";
const STAKING_ADDRESS    = "0xf5be3BbA8FB7cd06380b8D902eA976F0fAc8387F";

/* ================= ABIs ================= */
const TOKEN_ABI = [
 "function approve(address,uint256) external returns(bool)",
 "function decimals() view returns(uint8)"
];

const STAKING_ABI = [
 "function stake(uint256) external",
 "function getStakeInfo(address) view returns(uint256,uint256,uint256,bool)"
];

let provider, signer, token, staking;

/* ================= WALLET CONNECT (FIXED) ================= */
async function connectWallet(){
 try{
   if(!window.ethereum){
     alert("Open inside MetaMask or TokenPocket");
     return;
   }

   provider = new ethers.providers.Web3Provider(window.ethereum);

   const acc = await provider.listAccounts();
   if(acc.length === 0){
     await provider.send("eth_requestAccounts", []);
   }

   signer = provider.getSigner();
   const network = await provider.getNetwork();
   if(network.chainId !== 56){
     alert("Please switch to BSC Mainnet");
     return;
   }

   token   = new ethers.Contract(GARV_TOKEN_ADDRESS, TOKEN_ABI, signer);
   staking = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);

   const address = await signer.getAddress();
   document.getElementById("walletStatus").innerText =
     "Wallet Connected: " + address.slice(0,6) + "..." + address.slice(-4);

 }catch(e){
   console.log(e);
   alert("Wallet connection cancelled");
 }
}

/* ================= STAKE ================= */
async function stake(){
 if(!staking){ alert("Connect wallet first"); return; }

 const amt = document.getElementById("amount").value;
 if(!amt || amt<=0){ alert("Enter valid amount"); return; }

 try{
   const decimals = await token.decimals();
   const value = ethers.utils.parseUnits(amt,decimals);

   const tx1 = await token.approve(STAKING_ADDRESS,value);
   await tx1.wait();

   const tx2 = await staking.stake(value);
   await tx2.wait();

   alert("Stake successful");
 }catch(e){
   console.log(e);
   alert("Transaction failed or rejected");
 }
}

/* ================= CHECK STAKE ================= */
async function checkStake(){
 if(!staking){ alert("Connect wallet first"); return; }

 try{
   const addr = await signer.getAddress();
   const info = await staking.getStakeInfo(addr);
   alert("Staked Amount: " + ethers.utils.formatUnits(info.amount,18));
 }catch(e){
   console.log(e);
   alert("Unable to fetch stake info");
 }
}
</script>

</body>
</html>
