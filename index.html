<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GARV Token Staking</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(180deg,#020b1c,#031a3a);
    color: #fff;
  }
  .box {
    max-width: 420px;
    margin: 40px auto;
    padding: 20px;
    background: #0b2345;
    border-radius: 14px;
  }
  h1 { text-align:center; }
  button {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    background: #1aa3ff;
    color: #fff;
  }
  input {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
  }
  .info {
    margin-top: 12px;
    padding: 10px;
    background: #061a33;
    border-radius: 8px;
    font-size: 14px;
  }
</style>
</head>

<body>

<script>
/* ===============================
   WALLET-ONLY ENV CHECK
================================ */
if (typeof window.ethereum === "undefined") {
  document.body.innerHTML = `
    <div style="height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;">
      <div>
        <h2>GARV Staking DApp</h2>
        <p>This DApp works only inside decentralized wallets.</p>
        <p><b>Open using:</b></p>
        <p>• TokenPocket<br>• MetaMask</p>
        <p style="color:#1aa3ff">Paste this link inside wallet DApp browser</p>
      </div>
    </div>`;
  throw new Error("Not in wallet");
}
</script>

<div class="box">
  <h1>GARV Token Stake Now</h1>

  <div class="info" id="walletStatus">Wallet: Not Connected</div>
  <button onclick="connectWallet()">Connect Wallet</button>

  <div class="info" id="priceBox">Live GARV Price: Loading…</div>

  <input id="stakeAmount" placeholder="Enter GARV Amount" />
  <button onclick="stakeGARV()">Stake GARV</button>

  <button onclick="checkStake()">Check My Stake</button>

  <div class="info" id="result"></div>
</div>

<script>
/* ===============================
   CONFIG
================================ */
const GARV_TOKEN_ADDRESS = "0x15e4f5092af30ea702dcbac71194ccf08885688d";
const STAKING_ADDRESS   = "0xf5be3BbA8FB7cd06380b8D902eA976F0fAc8387F";
const PANCAKE_PAIR      = "0x00bb266615faeaae9d9d5b17668829580a038b9b";

const TOKEN_ABI = [
  "function approve(address spender,uint256 amount)",
  "function balanceOf(address owner) view returns(uint256)",
  "function decimals() view returns(uint8)"
];

const STAKING_ABI = [
  "function stake(uint256 amount)",
  "function getStakeInfo(address user) view returns(uint256,uint256,uint256,bool)"
];

let provider, signer, user;

/* ===============================
   CONNECT WALLET
================================ */
async function connectWallet() {
  try {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const network = await provider.getNetwork();

    if (network.chainId !== 56) {
      alert("Switch to BSC Mainnet");
      return;
    }

    signer = provider.getSigner();
    user = await signer.getAddress();

    document.getElementById("walletStatus").innerText =
      "Wallet Connected: " + user.slice(0,6) + "..." + user.slice(-4);

  } catch (e) {
    alert("Wallet connection rejected");
  }
}

/* ===============================
   STAKE GARV
================================ */
async function stakeGARV() {
  try {
    if (!signer) return alert("Connect wallet first");

    const amount = document.getElementById("stakeAmount").value;
    if (!amount || amount <= 0) return alert("Enter valid amount");

    const token = new ethers.Contract(GARV_TOKEN_ADDRESS, TOKEN_ABI, signer);
    const staking = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);

    const decimals = await token.decimals();
    const value = ethers.utils.parseUnits(amount, decimals);

    const tx1 = await token.approve(STAKING_ADDRESS, value);
    await tx1.wait();

    const tx2 = await staking.stake(value);
    await tx2.wait();

    document.getElementById("result").innerText = "Staking successful";

  } catch (e) {
    document.getElementById("result").innerText = "Staking failed";
  }
}

/* ===============================
   CHECK STAKE
================================ */
async function checkStake() {
  try {
    if (!signer) return alert("Connect wallet first");

    const staking = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, provider);
    const info = await staking.getStakeInfo(user);

    document.getElementById("result").innerText =
      "Staked: " + ethers.utils.formatUnits(info[0],18) +
      " | Unlock: " + new Date(info[2]*1000).toLocaleString();

  } catch (e) {
    document.getElementById("result").innerText = "No active stake";
  }
}
</script>

</body>
</html>
