<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GARV Token Staking</title>

<!-- Ethers v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg,#071b2f,#0a2e4f);
  color:#fff;
}
.container{
  max-width:420px;
  margin:40px auto;
  padding:20px;
}
.card{
  background:#0f3557;
  border-radius:14px;
  padding:20px;
  margin-bottom:18px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#1ea7ff;
  color:#fff;
  font-size:16px;
}
input{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  margin-bottom:12px;
}
.small{
  font-size:13px;
  opacity:0.9;
  text-align:center;
}
</style>
</head>

<body>

<!-- üîí WALLET-ONLY LOCK -->
<script>
if (!window.ethereum) {
  document.body.innerHTML = `
    <div style="padding:30px;text-align:center">
      <h2>GARV Staking DApp</h2>
      <p>This DApp works only inside decentralized wallets.</p>
      <p>Open using MetaMask or TokenPocket.</p>
    </div>
  `;
}
</script>

<div class="container">

  <div class="card">
    <h2>GARV Token Stake Now</h2>
    <p id="walletStatus" class="small">Wallet: Not Connected</p>
    <button onclick="connectWallet()">Connect Wallet</button>
  </div>

  <div class="card">
    <h3>Live GARV Price</h3>
    <p class="small">via PancakeSwap (on-chain)</p>
    <p id="price">Loading...</p>
  </div>

  <div class="card">
    <input type="number" id="amount" placeholder="Enter GARV Amount"/>
    <button onclick="stake()">Stake GARV</button>
  </div>

  <div class="card">
    <button onclick="checkStake()">Check My Stake</button>
    <p id="stakeInfo" class="small"></p>
  </div>

</div>

<script>
let provider, signer, token, staking;

// ‚úÖ ADDRESSES
const GARV_TOKEN_ADDRESS = "0x15e4f5092af30ea702dcbac71194ccf08885688d";
const STAKING_ADDRESS    = "0xf5be3BbA8FB7cd06380b8D902eA976F0fAc8387F";
const PANCAKE_PAIR       = "0x00bb266615faeaae9d9d5b17668829580a038b9b";

// ‚úÖ ERC20 ABI (MINIMAL)
const TOKEN_ABI = [
  "function approve(address,uint256) external returns(bool)",
  "function balanceOf(address) view returns(uint256)",
  "function decimals() view returns(uint8)"
];

// ‚úÖ STAKING ABI (MINIMAL)
const STAKING_ABI = [
  "function stake(uint256 amount) external",
  "function getStakeInfo(address user) view returns(uint256,uint256,uint256,bool)"
];

// üîó CONNECT WALLET
async function connectWallet(){
  try{
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();

    const network = await provider.getNetwork();
    if(network.chainId !== 56){
      alert("Please switch to BSC Mainnet");
      return;
    }

    token   = new ethers.Contract(GARV_TOKEN_ADDRESS, TOKEN_ABI, signer);
    staking = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);

    const addr = await signer.getAddress();
    document.getElementById("walletStatus").innerText =
      "Wallet Connected: " + addr.slice(0,6) + "..." + addr.slice(-4);

  }catch(e){
    alert("Wallet connection rejected");
  }
}

// üîê STAKE
async function stake(){
  try{
    const amount = document.getElementById("amount").value;
    if(!amount || amount <= 0){ alert("Enter amount"); return; }

    const decimals = await token.decimals();
    const value = ethers.utils.parseUnits(amount, decimals);

    await token.approve(STAKING_ADDRESS, value);
    await staking.stake(value);

    alert("Stake successful");
  }catch(e){
    alert("Stake failed");
  }
}

// üìä CHECK STAKE
async function checkStake(){
  try{
    const addr = await signer.getAddress();
    const info = await staking.getStakeInfo(addr);
    document.getElementById("stakeInfo").innerText =
      "Staked: " + ethers.utils.formatUnits(info[0],18);
  }catch(e){
    alert("Unable to fetch stake");
  }
}
</script>

</body>
</html>
